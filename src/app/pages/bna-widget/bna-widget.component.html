<div *ngIf="dataLoaded$ | async">

    <table class="table table-bordered table-responsive custom-table-padding" #rootCauseAnalysisTable *ngIf="configuration$ | async as rootCauseAnalysisConfiguration;">
        <thead class="table-header-cell thead-light">
            <tr>
                <th width="1%"> SN. </th>
                <th width="{{(100)/(rootCauseAnalysisConfiguration.dataElements.length + 1)}}%" [hidden]="dataElement.isHidden" *ngFor="let dataElement of rootCauseAnalysisConfiguration.dataElements;">
                    {{dataElement.name}}
                </th>
            </tr>
        </thead>
        <tbody *ngIf=" data$ | async as rootCauseAnalysisData;" [@listEnter]>
            <tr title="Right click for edit/delete options" *ngFor="let dataItem of rootCauseAnalysisData ;  let i = index; trackBy:dataItem?.id">
                <td> {{i+1}} </td>
                <td [hidden]="dataElement.isHidden || (toBeDeleted[dataItem.id])" *ngFor="let dataElement of rootCauseAnalysisConfiguration.dataElements; let j = index"
                    [ngClass]="{'auto-filled': dataElement.valueType == 'AUTO_FILLED'}" (dblclick)="onToggleEdit($event,dataItem)"
                    (contextmenu)="onEnableContextMenu($event, dataItem)">
                    <div *ngIf="(!dataItem.isActive && !dataItem.isHidden) || (dataItem.isActive && !dataElement.optionSetValue && dataElement.valueType == 'AUTO_FILLED')"
                        class="form-control auto-filled-label table-cell-data">
                        {{dataItem.dataValues[dataElement.id]}}
                    </div>
                    <app-select-box-input [backgroundColor]="savingColor" *ngIf="dataItem.isActive && dataElement.optionSetValue" [dataItemValue]="dataItem.dataValues[dataElement.id]"
                        [dataElement]="dataElement" [dataValues]="dataItem.dataValues" (updateDataValues)="onDataValuesUpdate($event, dataItem, rootCauseAnalysisConfiguration.dataElement)"
                        [groups]="routerParams?.groups"></app-select-box-input>
                    <textarea class="form-control table-cell-data custom-text-area" (blur)="onDataValueUpdate(dataElement.id, dataItem, $event, rootCauseAnalysisConfiguration.dataElement)"
                        *ngIf="dataItem.isActive && !dataElement.optionSetValue && dataElement.valueType == 'TEXT'" placeholder="{{dataElement.name}}"
                        tabindex="j-9" autofocus> {{dataItem.dataValues[dataElement.id]}}</textarea>
                    <a title="Save when done" class="text-secondary custom-done-icon" (click)="onDoneEditing($event, dataItem)" *ngIf="(j == (rootCauseAnalysisConfiguration.dataElements.length - 1)) && dataItem.isActive">
                        <i class="icon-ok-circled2"></i></a>
                </td>
                <td class="delete-message" *ngIf="(toBeDeleted[dataItem.id])" colspan="100%">
                    Are you sure wish to delete this data? <br>
                    <button class="btn btn-sm btn-success" (click)="onToggleCancelAction($event, dataItem, 'DELETE')">
                        <i class="icon-cancel"></i> No</button>&nbsp;
                    <button class="btn btn-sm btn-danger" (click)="onDeleteRootCauseAnalysisData(dataItem)">
                        <i class="icon-ok-circled2"></i> Yes</button>
                </td>
            </tr>
            <tr *ngIf="!rootCauseAnalysisData.length">
                <td colspan="100%" class="text-sm text-secondary">
                    <p class="text-center mb-0">
                        <i>
                            No registered root causes for {{selectedOrgUnit}} in {{selectedPeriod}}
                        </i>
                    </p>
                </td>
            </tr>
        </tbody>
    </table>

    <div class="d-flex justify-content-between" *ngIf="configuration$ | async as dataConfiguration">
      <div class="mr-3 text-secondary">
        <button class="btn btn-sm btn-outline-secondary rounded" *ngIf="(dataLoaded$ | async)" (click)="downloadTable('XLSX')">
          <i class="icon-download"></i>  </button>
      </div>
        <div class="mr-3 text-secondary">
            <i style="font-size:11px"> Autosave is on, leave a cell to save
            </i>
          <button class="btn btn-sm btn-outline-secondary" *ngIf="(dataLoaded$ | async)" (click)="onToggleAddNewRootCauseAnalysisData(dataConfiguration)">
            Add New </button>
        </div>
    </div>
</div>

<div *ngIf="showContextMenu===true">
    <app-widget-context-menu [dataItem]="contextmenuDataItem" appClickOutside (clickOutside)="showContextMenu=false" (openEditForm)="onToggleEdit($event)"
        (openDeleteForm)="onToggleDelete($event)" [x]="contextmenuX" [y]="contextmenuY">{{contextmenuX}}</app-widget-context-menu>
</div>

<div [@fadeInOut] *ngIf="((notification$ | async)?.message) as notificationMessage">
    <app-widget-notification-bar (resetNotification)="onResetNotification($event)" [notification]="notificationMessage"></app-widget-notification-bar>
</div>

<div *ngIf="(!configurationLoaded$ | async) || !(dataLoaded$ | async)">
    <div class="d-flex my-1">
        <div class="flex-fill mx-1" *ngFor="let count of [1,2,3,4,5,6,7]">
            <app-widget-item-loader [height]="'40px'"></app-widget-item-loader>
        </div>
    </div>
    <div class="d-flex my-1">
        <div class="flex-fill mx-1" *ngFor="let count of [1,2,3,4,5,6,7]">
            <app-widget-item-loader [height]="'40px'"></app-widget-item-loader>
        </div>
    </div>
    <div class="d-flex justify-content-between my-2 mx-1">
      <div style="width: 150px;">
        <app-widget-item-loader [height]="'40px'"></app-widget-item-loader>
      </div>
        <div style="width: 150px;">
            <app-widget-item-loader [height]="'40px'"></app-widget-item-loader>
        </div>
    </div>
</div>
